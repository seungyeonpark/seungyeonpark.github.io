---
title: "Prepared Statement와 실행 계획"
excerpt: ""

categories:
  - ETC
tags:
  - [RDBMS]

permalink: /etc/prepared-statement

toc: true
toc_sticky: true

date: 2024-07-06
last_modified_at: 2024-07-06
---

```
📌 콘솔에서 확인한 실행 계획과 
   실제 서버에 기록된 쿼리의 실행 계획이 
   크게 차이나는 케이스에 대한 분석!
```

## 1. Prepared Statement
- Prepared Statement는 데이터베이스에 쿼리를 미리 컴파일해 두고, 나중에 파라미터만 바꿔서 실행하는 방식이다. SQL 쿼리를 미리 준비해두고, 실행할 때 값만 대체하는 방식으로 동작
- Prepared Statement는 쿼리를 미리 컴파일해 놓기 때문에, 동일한 쿼리를 여러 번 실행할 때 매번 컴파일하는 비용이 절감된다.
- 데이터베이스는 Prepared Statement를 캐시하여 재사용할 수 있기 때문에 실행 속도가 빨라진다.

## 2. Execution Plan
- 실행 계획은 데이터베이스가 쿼리를 최적화하여 실행하기 위해 수립하는 단계이다. 데이터베이스의 쿼리 옵티마이저는 통계 정보를 기반으로 최적의 방법을 찾아낸다.
- 과정
  1. 파싱: SQL 쿼리를 파싱하여 구문 트리를 생성한다.
  2. 옵티마이징: 구문 트리를 최적화하여 효율적인 실행 계획을 수립한다. 이 과정에서 데이터베이스의 통계 정보, 인덱스, 조인 방법 등이 고려된다.
  3. 실행: 최적화된 실행 계획에 따라 쿼리를 실행한다.
- 실행 계획은 데이터의 분포, 테이블의 크기, 인덱스의 유무 등 여러 요인에 의해 달라질 수 있다. 따라서 동일한 쿼리라 하더라도 실행 시점이나 조건에 따라 실행 계획이 달라질 수 있다.

## 3. Prepared Statement와 실행계획
- Prepared Statement를 사용할 때, 데이터베이스는 평균적인 수치를 기준으로 실행 계획을 최적화한다. 
  - 이는 쿼리 옵티마이저가 특정 패턴이나 통계적인 평균을 바탕으로 실행 계획을 세우기 때문이다. 
  - 예를 들어, 날짜 범위가 1일일 수도 있고, 한 달일 수도 있을 때, 옵티마이저는 다양한 시나리오를 고려하여 평균적인 실행 계획을 수립한다.

- Prepared Statement를 사용하면 오라클이 binding 변수를 사용한다. 
  - 바인드 변수를 사용한다는 것은 SQL이 최초 수행될 때 최적화를 거친 실행계획을 캐시에 저장하고 실행 시점에는 그것을 그대로 가져와 값만 다르게 바인딩하면서 반복 재사용하는 것이다. 
  - 여기서 변수를 바인딩하는 시점은 최적화 이후이다. 즉, 나중에 반복 수행될 때 어떤 값이 입력될지 알 수 없기 때문에 옵티마이저는 조건절 컬럼의 데이터 분포가 균일하다는 가정을 세우고 최적화를 수행한다. 
  - 컬럼에 대한 히스토그램 정보가 딕셔너리에 저장되어 있어도 이를 활용하지 못한다, 컬럼 분포가 균일할 때는 이렇게 처리해도 괜찮으나 그렇지 않을 때는 **바인딩되는 값에 따라 쿼리 성능이 다르게 나타날 수 있다**.
  - 예를 들어 select하는 테이블의 특정 컬럼에 분포도가 1%인 데이터는 테이블의 인덱스를 타는 것이 바람직하지만, 분포도가 99%인 데이터는 전체 테이블을 스캔하는 것이 효율적이다.