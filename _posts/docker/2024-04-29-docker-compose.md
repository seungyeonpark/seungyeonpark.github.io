---
title: "Docker 컴포즈"
excerpt: "Docker 컴포즈에 대해 알아보자"

categories:
  - Docker
tags:
  - [docker]

permalink: /docker/docker-compose

toc: true
toc_sticky: true

date: 2024-04-29
last_modified_at: 2024-04-29
---

## 도커 컴포즈 파일의 구조
- 도커 컴포즈를 사용하면 여러 컨테이너에 걸쳐 실행되는 애플리케이션을 정의하고 관리할 수 있다.
- 각 컴포넌트는 자신만의 경량 컨테이너에서 실행되며 도커가 표준 네트워크 프로토콜을 통해 이들 컨테이너를 엮어낸다.
- 직접 순서대로 각각의 컨테이너를 도커 명령행을 통해 일일이 옵션을 지정해 가며 실행할 수도 있겠지만, 이런 수동 프로세스는 실수를 유발할 수 있다. 수동 실행 과정에서 조금만 옵션을 잘못 지정해도 애플리케이션이 정상적으로 동작하지 않거나 컨테이너 간 통신에 문제가 생길 수 있기 때문이다.
- 이런 방법 대신 도커 컴포즈 파일에 애플리케이션의 구조를 정의할 수 있다.
- 도커 컴포즈 파일은 모든 컴포넌트가 실행 중일 때 어떤 상태여야 하는지를 기술하는 파일이다.
  - docker container run 명령으로 컨테이너를 실행할 때 지정하는 모든 옵션을 모아둔 파일이다.
  - 도커 컴포즈 파일을 작성하고 나면 도커 컴포즈 도구를 사용해 애플리케이션을 실행한다.
  - 그러면 도커 컴포즈가 컨테이너, 네트워크, 볼륨 등 필요한 모든 도커 객체를 만들도록 도커 API에 명령을 내린다.
- 도커 컴포즈 파일 예시

    ``` yaml
    version: '3.7'
    
    services:
    
      todo-web: 
        image: diamol/ch06-todo-list
        ports:
          - "8020:80"
        networks:
          - app-net
            external:
              name: nat
    ```

  - version은 이 파일에 사용된 도커 컴포즈 파일 형식의 버전을 가리킨다. 여러 번에 걸쳐 문법과 표현 가능한 요소에 많은 변화가 있었으므로 먼저 정의가 따르는 형식 버전을 지정할 필요가 있다.
  - services는 애플리케이션을 구성하는 모든 컴포넌트를 열거하는 부분이다. 도커 컴포즈에서는 실제 컨테이너 대신 서비스(service) 개념을 단위로 삼는다. 하나의 서비스를 같은 이미지로 여러 컨테이너에서 실행할 수 있기 때문이다.
    - image는 실행할 이름을 지정하는 필드
    - ports는 공개할 포트에 대한 정보
    - networks는 컨테이너가 접속할 도커 네트워크를 정의하는 필드
  - 서비스 이름은 컨테이너의 이름이자 도커 네트워크상에서 다른 컨테이너들이 해당 컨테이너를 식별하기 위한 DNS 네임으로도 쓴다.
  - external 필드의 의미는 nat 네트워크가 이미 존재하므로 새로 생성하지 말라는 뜻이다.
  - 최종적인 결과는 `docker container run -p 8020:80 --name todo-web --network nat diamol/ch06-todo-list` 명령을 실행한 것과 같은 상태가 된다.
- 도커 컴포즈를 사용하려면 명령행에서 docker-compose 명령을 실행하면 된다. 
- 도커 컴포즈는 up 명령을 실행하면 컴포즈 파일을 체크하고 애플리케이션을 정의된 상태로 실행하기 위해 필요한 요소를 준비하기 시작한다.
```
docker network create nat

cd ./ch07/exercises/todo-list

docker-compose-up
```
- 컴포즈 스크립트의 external 필드에 정의된 네트워크는 애플리케이션 실행 전에 생성돼 있어야 한다. 아직 해당 네트워크가 존재하지 않는다면 위 명령으로 nat이라는 이름의 도커 네트워크를 생성한다.
- docker-compose up 명령으로 애플리케이션이 실행된다. 도커 컴포즈는 현재 있는 리소스와 애플리케이션을 구성하는 리소스를 비교해 더 필요한 요소를 생성한다.
- 최종적으로 애플리케이션을 구성하는 단일 컨테이너가 실행된다. 컨테이너의 로그에 표준 출력을 연결해 애플리케이션의 로그를 보여 준다. 
- 리눅스 컨테이너를 사용한다면 도커 컴포즈가 네트워크를 대신 관리해 주지만, 윈도우 컨테이너를 사용한다면 도커를 설치할 때 자동으로 생성되는 기본 네트워크 nat을 사용해야 한다.
- 도커 컴포즈 파일은 애플리케이션의 소스 코드, Dockerfile 스크립트와 함께 형상 관리 도구로 관리된다. 그리고 이 파일에 애플리케이션의 모든 실행 옵션이 기술된다. 따라서 애플리케이션 이미지 이름이나 공개해야 할 포트 번호를 따로 문서화할 필요가 없다.

## 도커 컴포즈를 사용해 여러 컨테이너로 구성된 애플리케이션 실행
## 도커 컨테이너 간 통신
## 도커 컴포즈로 애플리케이션 설정값 지정
## 도커 컴포즈의 한계